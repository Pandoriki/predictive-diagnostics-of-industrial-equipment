version: '3.8'

services:
  # --- 1. API GATEWAY (ОСНОВНОЙ БЭКЕНД) ---
  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile.backend 
    ports:
      - "8080:8000"             
    networks:
      - pdm-network
    environment:
      ML_SERVICE_URL: "http://ml-service:8000"   
      DATA_SERVICE_URL: "http://data-service:8000" 
      PYTHONPATH: "/app"         
    volumes:                    
      - ./backend:/app/backend 
      - ./configs:/app/configs   
      - ./src:/app/src           
      - ./models:/app/models     
      - ./backend/requirements.txt:/app/requirements.txt 
    restart: unless-stopped      

  # --- 2. ML INFERENCE SERVICE ---
  ml-service:
    build:
      context: .
      dockerfile: ml-service/Dockerfile.ml
    networks:
      - pdm-network
    environment:
      MODELS_DIR: "/app/models"
      PYTHONPATH: "/app"       
    volumes:                    
      - ./models:/app/models    
      - ./configs:/app/configs  
      - ./src:/app/src         
      - ./data:/app/data         # Data-service загружает data/, но ml-service тоже нужен, чтобы получить сырые данные для PredictRequest, который будет в go-backend. 
                                 # Либо: backend/app.main сам загрузит, и не надо будет для ml-service
    restart: unless-stopped

  # --- 3. DATA SERVICE ---
  data-service:
    build:
      context: .
      dockerfile: data-service/Dockerfile.data
    networks:
      - pdm-network
    environment:
      PYTHONPATH: "/app"        
    volumes:                   
      - ./data:/app/data        
      - ./configs:/app/configs 
      - ./src:/app/src           
    restart: unless-stopped
  # --- 4. FRONTEND SERVICE (НОВЫЙ!) ---
  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile.frontend
    networks:
      - pdm-network
    depends_on:
      - backend
    environment:
      # ИЗМЕНЕНИЕ: URL для API теперь указывает на корень и новый путь.
      # Лучше всего использовать относительный путь. Так фронтенд не будет
      # привязан к конкретному домену (localhost). Он будет делать запросы
      # на тот же хост, с которого загрузился.
      VITE_API_URL: "/api" 
      VITE_USE_MOCKS: "false" 
    restart: unless-stopped

  # --- NGINX REVERSE PROXY ---
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile.nginx
    ports:
      # ИЗМЕНЕНИЕ: Меняем порт на стандартный HTTP порт 80.
      - "80:80"
    networks:
      - pdm-network
    depends_on:
      - backend
      - frontend
    restart: unless-stopped

# --- ОПРЕДЕЛЕНИЕ СЕТИ ---
networks:
  pdm-network:
    driver: bridge